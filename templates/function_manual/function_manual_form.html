{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/function_manual.css' %}">
{% endblock %}

{% block content %}
    <div id="profileFormApp" v-cloak
         data-is-edit="{% if form.instance.pk %}true{% else %}false{% endif %}"
         data-url-units="{% url 'function_manual:api_units_root' %}"
         data-url-next-code="{% url 'function_manual:api_next_code' 0 %}"
         data-url-matrix="{% url 'function_manual:matrix_list' %}"
         data-url-cancel="{% url 'function_manual:profile_list' %}"
         data-url-save-action="{% url 'function_manual:api_profile_save' %}"
         data-url-valuation-nodes="{% url 'function_manual:api_valuation_nodes' %}">


        <!-- HEADER CON STEPPER -->
        <div class="header-card">
            <div class="wizard-header-info">
                <h1>[[ isEdit ? 'Editar Perfil' : 'Nuevo Perfil de Puesto' ]]</h1>
                <p>Paso [[ currentStep ]]: [[ stepLabels[currentStep-1] ]]</p>
            </div>

            <!-- Stepper Visual -->
            <div class="wizard-stepper">
                <div v-for="step in 4" :key="step" class="step-item"
                     :class="{ 'active': currentStep === step, 'completed': currentStep > step }">
                    <div class="step-dot">[[ step ]]</div>
                </div>
            </div>
        </div>

        <form @submit.prevent="submitForm" class="wizard-container">
            {% csrf_token %}

            <!-- PASO 1: ESTRUCTURA E IDENTIFICACIÓN -->
            <section v-show="currentStep === 1" class="wizard-step-content">
                <div class="form-section-card">
                    <div class="section-title"><i class="fa-solid fa-sitemap"></i> Ubicación Organizacional</div>
                    <div class="unit-dynamic-grid">
                        <div v-for="(level, index) in unitLevels" :key="index" class="unit-level-box">
                            <label class="form-label">[[ getLevelLabel(index) ]]</label>
                            <select class="form-control select2-unit" :data-index="index"
                                    v-model="selectedUnits[index]">
                                <option value="">Seleccione una opción...</option>
                                <option v-for="unit in level.options" :key="unit.id" :value="unit.id">[[ unit.name ]]
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section-card mt-3">
                    <div class="section-title"><i class="fa-solid fa-id-card"></i> Identificación</div>
                    <div class="grid-2-cols">
                        <div class="form-group">
                            <label class="form-label">Código Posicional</label>
                            <input type="text" v-model="formData.position_code" class="form-control bg-readonly"
                                   readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Denominación Específica</label>
                            <input type="text" v-model="formData.specific_job_title" class="form-control" required
                                   placeholder="Ej: Analista de Sistemas 1">
                        </div>
                    </div>
                </div>
            </section>

            <section v-show="currentStep === 2" class="wizard-step-content">
                <div class="form-section-card">
                    <div class="section-title">
                        <i class="fa-solid fa-diagram-predecessor"></i>
                        Valoración Normativa (Proceso de Clasificación)
                    </div>

                    <div class="valuation-chain-container">
                        <div v-for="(level, index) in valuationLevels" :key="index" class="valuation-node-box">
                            <label class="form-label">[[ getValuationLabel(level.type) ]]</label>
                            <select class="form-control select2-valuation"
                                    :data-index="index"
                                    v-model="selectedNodes[index]">
                                <option value="">Seleccione una opción...</option>
                                <option v-for="node in level.options" :key="node.id" :value="node.id">
                                    [[ node.name ]]
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- RESULTADO FINAL AUTOMÁTICO -->
                    <div class="classification-result-banner mt-4" v-if="matchResult">
                        <div class="match-icon"><i class="fa-solid fa-award"></i></div>
                        <div class="match-details">
                            <div class="match-group">[[ matchResult.group ]]</div>
                            <div class="match-label">GRADO ESCALA: [[ matchResult.grade ]]</div>
                        </div>
                        <div class="match-salary">
                            <small>RMU ACORDADO:</small>
                            <span>$[[ selectedMatrixItem.remuneration ]]</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PASO 3: FUNCIONES / ACTIVIDADES -->
            <section v-show="currentStep === 3" class="wizard-step-content">
                <div class="form-section-card">
                    <div class="section-header-inline">
                        <div class="section-title">
                            <i class="fa-solid fa-list-check"></i> Actividades Esenciales
                        </div>
                        <button type="button" class="btn-add-activity" @click="addActivity">
                            <i class="fas fa-plus"></i> Añadir Actividad
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table-premium">
                            <thead>
                            <tr>
                                <th style="width: 200px;">Verbo de Acción</th>
                                <th>Descripción de la Actividad (¿Qué hace? + ¿Sobre qué?)</th>
                                <th style="width: 250px;">Conocimientos Adicionales</th>
                                <th style="width: 50px;"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="(act, idx) in activities" :key="idx" class="row-animated">
                                <td>
                                    <select v-model="act.action_verb" class="form-select-premium">
                                        <option value="">Seleccione...</option>
                                        <option v-for="v in filteredVerbs" :key="v.id" :value="v.id">[[ v.name ]]
                                        </option>
                                    </select>
                                </td>
                                <td>
                                    <textarea v-model="act.description" class="form-textarea-inline"
                                              placeholder="Descripción..."></textarea>
                                </td>
                                <td>
                                    <input type="text" v-model="act.additional_knowledge" class="form-input-premium"
                                           placeholder="Ej: Normativa contable, Excel...">
                                </td>
                                <td class="cell-top">
                                    <button type="button" class="btn-delete-icon" @click="removeActivity(idx)">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="normative-note">
                        <i class="fa-solid fa-circle-info"></i> Nota: Según la norma MDT-2025, debe describir entre 5 y
                        10 actividades principales.
                    </div>
                </div>
            </section>

            <!-- PASO 4: COMPLETAR PERFIL -->
            <section v-show="currentStep === 4" class="wizard-step-content">
                <div class="form-section-card">
                    <div class="section-title"><i class="fa-solid fa-feather"></i> Definiciones Finales</div>
                    <div class="form-group">
                        <label class="form-label">Misión del Puesto</label>
                        <textarea v-model="formData.mission" class="form-control" rows="3"></textarea>
                        <small class="form-hint">[[ missionPreview ]]</small>
                    </div>
                    <div class="grid-2-cols mt-3">
                        <div class="form-group">
                            <label class="form-label">Área de Conocimiento</label>
                            <textarea v-model="formData.knowledge_area" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Especificidad de la Experiencia</label>
                            <textarea v-model="formData.experience_details" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div class="grid-2-cols mt-3">
                        <div class="form-group">
                            <label class="form-label">Relaciones Internas/Externas</label>
                            <textarea v-model="formData.interface_relations" class="form-control" rows="2" placeholder="Describa con quién se relaciona el puesto"></textarea>
                        </div>
                        <div class="form-group">
                             <label class="form-label">Temática de Capacitación</label>
                             <textarea v-model="formData.training_topic" class="form-control" rows="2" placeholder="Describa la temática de capacitación requerida"></textarea>
                        </div>
                    </div>

                    <!-- SECCIÓN DE COMPETENCIAS -->
                    <div class="section-title mt-4"><i class="fa-solid fa-brain"></i> Competencias del Perfil</div>
                    
                    <div class="row">
                        <!-- Técnicas -->
                        <div class="col-md-4">
                            <div class="p-3 bg-white border rounded">
                                <h6 class="text-primary border-bottom pb-2 mb-3">Técnicas</h6>
                                <div v-for="(sel, i) in selectedTechnical" :key="'tech-'+i" class="mb-3">
                                    <label class="form-label small text-muted">Opción [[ i+1 ]]</label>
                                    <select class="form-control select2-comp-tech" :data-index="i" v-model="selectedTechnical[i]">
                                        <option value="">Seleccione...</option>
                                        <option v-for="c in technicalList" :key="c.id" :value="c.id">[[ c.name ]]</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conductuales -->
                        <div class="col-md-4">
                            <div class="p-3 bg-white border rounded">
                                <h6 class="text-info border-bottom pb-2 mb-3">Conductuales</h6>
                                <div v-for="(sel, i) in selectedBehavioral" :key="'beh-'+i" class="mb-3">
                                    <label class="form-label small text-muted">Opción [[ i+1 ]]</label>
                                    <select class="form-control select2-comp-beh" :data-index="i" v-model="selectedBehavioral[i]">
                                        <option value="">Seleccione...</option>
                                        <option v-for="c in behavioralList" :key="c.id" :value="c.id">[[ c.name ]]</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Transversales -->
                        <div class="col-md-4">
                            <div class="p-3 bg-white border rounded">
                                <h6 class="text-secondary border-bottom pb-2 mb-3">Transversales</h6>
                                <div v-for="(sel, i) in selectedTransversal" :key="'trans-'+i" class="mb-3">
                                    <label class="form-label small text-muted">Opción [[ i+1 ]]</label>
                                    <select class="form-control select2-comp-trans" :data-index="i" v-model="selectedTransversal[i]">

                                        <option value="">Seleccione...</option>
                                        <option v-for="c in transversalList" :key="c.id" :value="c.id">[[ c.name ]]</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- NAVEGACIÓN DEL WIZARD -->
            <div class="form-section-card mt-3 mb-5 d-flex justify-content-center flex-wrap"
                 v-show="currentStep > 1 || (firstUnitSelected && formData.specific_job_title)">

                <button type="button" class="btn-wizard-nav btn-wizard-cancel" @click="cancelProcess">
                    <i class="fa-solid fa-xmark"></i> Cancelar
                </button>

                <button v-if="currentStep > 1" type="button" class="btn-wizard-nav btn-wizard-prev" @click="currentStep--">
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>

                <button v-if="currentStep < 4" type="button" class="btn-wizard-nav btn-wizard-next" @click="currentStep++" :disabled="isNextDisabled">
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>

                <button v-if="currentStep === 4" type="submit" class="btn-wizard-nav btn-wizard-save" :disabled="loading">
                    <i class="fa-solid fa-floppy-disk"></i> Finalizar y Guardar
                </button>
            </div>
        </form>

    </div>
    <script id="catalogs-data" type="application/json">
    {{ catalogs_json|safe }}
    </script>
    {% if initial_data %}
    <script id="initial-data" type="application/json">
    {{ initial_data|safe }}
    </script>
    {% endif %}
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/function_manual.js' %}"></script>
{% endblock %}