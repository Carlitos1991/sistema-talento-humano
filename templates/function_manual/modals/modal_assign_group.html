<!-- Modal para Asignar Grupo Ocupacional -->
<div id="assign-group-app" v-cloak>
    <div class="modal-overlay" :class="{ 'hidden': !isVisible }">
        <form @submit.prevent="submitAssignment" class="modal-container animate-scale-in" style="max-width: 700px;">
            {% csrf_token %}
            <div class="modal-header modal-header-gradient">
                <h3 class="modal-title text-white">
                    <i class="fa-solid fa-scale-balanced me-2"></i> Asignar Grupo Ocupacional
                </h3>
                <button type="button" class="btn-close-modal text-white-opacity" @click="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body modal-body-custom">
                <p class="text-sm text-gray-600 mb-4">
                    Seleccione el grupo ocupacional correspondiente basado en la valoración del perfil.
                </p>

                <!-- Indicador de carga -->
                <div v-if="!hasResultLevel" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2 text-sm text-gray-600">Cargando opciones...</p>
                </div>

                <!-- Cadena de valoración - Solo mostrar el nivel RESULT (7mo) cuando esté disponible -->
                <div v-else class="valuation-chain-container mb-4">
                    <div v-for="(level, index) in valuationLevels" 
                         :key="index" 
                         class="valuation-node-box"
                         v-show="level.type === 'RESULT'">
                        <label class="form-label">[[ getValuationLabel(level.type) ]]</label>
                        <select class="form-control select2-valuation-assign"
                                :data-index="index"
                                v-model="selectedNodes[index]"
                                :disabled="level.type !== 'RESULT'"
                                :required="level.type === 'RESULT'">
                            <option value="">Seleccione una opción...</option>
                            <option v-for="node in level.options" :key="node.id" :value="node.id">
                                [[ node.name ]]
                            </option>
                        </select>
                    </div>
                </div>


            </div>

            <div class="modal-footer modal-footer-spaced">
                <button type="button" class="btn-cancel" @click="closeModal">Cancelar</button>
                <button type="submit" class="btn-save" :disabled="loading || !hasResultSelected">
                    <span v-if="loading"><i class="fas fa-spinner fa-spin"></i> Guardando...</span>
                    <span v-else><i class="fas fa-check"></i> Asignar</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Script data -->
<script id="matrix-data" type="application/json">
{{ occupational_matrix_json|default:"[]"|safe }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if(document.getElementById('assign-group-app')) {
            const {createApp} = Vue;
            createApp({
                delimiters: ['[[', ']]'],
                data() {
                    return {
                        isVisible: false,
                        loading: false,
                        profileId: null,
                        selectedGroup: null,
                        allMatrix: [],
                        filteredMatrix: [],
                        // Lógica de valoración en cadena
                        valuationLevels: [],
                        selectedNodes: []
                    }
                },
                computed: {
                    hasResultSelected() {
                        const resultIndex = this.valuationLevels.findIndex(l => l.type === 'RESULT');
                        return resultIndex !== -1 && this.selectedNodes[resultIndex];
                    },
                    hasResultLevel() {
                        return this.valuationLevels.some(l => l.type === 'RESULT');
                    }
                },
                mounted() {
                    const tag = document.getElementById('matrix-data');
                    if (tag) {
                        try {
                            this.allMatrix = JSON.parse(tag.textContent);
                        } catch(e) { 
                            console.error("Error parsing matrix data", e); 
                        }
                    }

                    // Exponer globalmente
                    window.openAssignGroupModal = async (id) => {
                        this.profileId = id;
                        this.selectedGroup = null;
                        this.valuationLevels = [];
                        this.selectedNodes = [];
                        this.filteredMatrix = [];
                        this.isVisible = true;
                        
                        // Cargar la cadena de valoración precargada desde el backend
                        await this.loadProfileValuationChain(id);
                    };
                },
                methods: {
                    closeModal() {
                        this.isVisible = false;
                        this.valuationLevels = [];
                        this.selectedNodes = [];
                        this.filteredMatrix = [];
                    },
                    async loadProfileValuationChain(profileId) {
                        try {
                            // Primero obtener los valores seleccionados del perfil
                            const res = await fetch(`/function_manual/api/profile/${profileId}/valuation-chain/`);
                            const data = await res.json();
                            
                            if (!data.success) {
                                Swal.fire('Error', data.message || 'No se pudo cargar los datos del perfil', 'error');
                                return;
                            }
                            
                            const selected = data.selected_values;
                            console.log('Valores seleccionados del perfil:', selected);
                            
                            // Cargar la cadena de valoración secuencialmente
                            // Nivel 1: ROL
                            await this.fetchAndSelectLevel(null, 'ROLE', selected.role_id);
                            if (!this.selectedNodes[0]) {
                                console.error('No se pudo cargar nivel ROL');
                                return;
                            }
                            
                            // Nivel 2: INSTRUCCIÓN
                            await this.fetchAndSelectLevel(this.selectedNodes[0], 'INSTRUCTION', selected.instruction_id);
                            if (!this.selectedNodes[1]) {
                                console.error('No se pudo cargar nivel INSTRUCTION');
                                return;
                            }
                            
                            // Nivel 3: EXPERIENCIA (buscar por meses de experiencia)
                            await this.fetchAndSelectLevel(this.selectedNodes[1], 'EXPERIENCE', null, selected.experience_months);
                            if (!this.selectedNodes[2]) {
                                console.error('No se pudo cargar nivel EXPERIENCE');
                                return;
                            }
                            
                            // Nivel 4: DECISIÓN
                            await this.fetchAndSelectLevel(this.selectedNodes[2], 'DECISION', selected.decision_id);
                            if (!this.selectedNodes[3]) {
                                console.error('No se pudo cargar nivel DECISION');
                                return;
                            }
                            
                            // Nivel 5: IMPACTO
                            await this.fetchAndSelectLevel(this.selectedNodes[3], 'IMPACT', selected.impact_id);
                            if (!this.selectedNodes[4]) {
                                console.error('No se pudo cargar nivel IMPACT');
                                return;
                            }
                            
                            // Nivel 6: COMPLEJIDAD
                            await this.fetchAndSelectLevel(this.selectedNodes[4], 'COMPLEXITY', selected.complexity_id);
                            if (!this.selectedNodes[5]) {
                                console.error('No se pudo cargar nivel COMPLEXITY');
                                return;
                            }
                            
                            // Nivel 7: RESULT (SIN pre-selección, debe quedar vacío)
                            await this.fetchAndSelectLevel(this.selectedNodes[5], 'RESULT', null, null, false);
                            
                            console.log('Cadena de valoración cargada:', {
                                levels: this.valuationLevels.length,
                                selected: this.selectedNodes
                            });
                            
                            // Inicializar Select2 inmediatamente después de cargar RESULT
                            this.$nextTick(() => {
                                this.initSelect2Valuation();
                            });
                            
                        } catch(e) {
                            console.error('Error cargando cadena de valoración:', e);
                            Swal.fire('Error', 'Error al cargar los datos del perfil', 'error');
                        }
                    },
                    async fetchAndSelectLevel(parentNodeId, expectedType, catalogItemIdToSelect, experienceMonths = null, autoSelectFirst = true) {
                        // Cargar un nivel y pre-seleccionar el valor si se proporciona
                        const url = parentNodeId 
                            ? `/function_manual/api/valuation-nodes/?parent=${parentNodeId}` 
                            : '/function_manual/api/valuation-nodes/';
                        
                        try {
                            const res = await fetch(url);
                            const nodes = await res.json();
                            
                            console.log(`Nivel ${expectedType}:`, nodes.length, 'opciones');
                            
                            if (nodes.length > 0 && nodes[0].type === expectedType) {
                                this.valuationLevels.push({
                                    type: nodes[0].type,
                                    options: nodes
                                });
                                
                                // Determinar qué nodo seleccionar
                                let selectedNodeId = '';
                                
                                if (catalogItemIdToSelect) {
                                    // Buscar por catalog_item_id
                                    const matchingNode = nodes.find(n => n.catalog_item_id == catalogItemIdToSelect);
                                    if (matchingNode) {
                                        selectedNodeId = matchingNode.id;
                                        console.log(`  -> Seleccionado: ${matchingNode.name} (ID: ${selectedNodeId})`);
                                    } else {
                                        console.warn(`  -> No se encontró nodo con catalog_item_id=${catalogItemIdToSelect}`);
                                        if (autoSelectFirst) {
                                            selectedNodeId = nodes[0].id;
                                            console.log(`  -> Seleccionado primer nodo por defecto: ${nodes[0].name}`);
                                        }
                                    }
                                } else if (expectedType === 'EXPERIENCE' && experienceMonths !== null) {
                                    // Para EXPERIENCE, buscar por meses en name_extra
                                    const matchingNode = nodes.find(n => {
                                        if (!n.name_extra && !n.name) return false;
                                        
                                        // Usar name o name_extra según lo que esté disponible
                                        const nodeName = (n.name_extra || n.name || '').toLowerCase();
                                        
                                        // Si es 0 meses, buscar "no requerida" o "sin experiencia"
                                        if (experienceMonths === 0) {
                                            return nodeName.includes('no requerida') || 
                                                   nodeName.includes('sin experiencia') ||
                                                   nodeName.includes('no requiere') ||
                                                   nodeName.includes('0 meses') ||
                                                   nodeName === '0';
                                        }
                                        
                                        // Para otros valores, buscar el número en el texto
                                        const text = n.name_extra || n.name || '';
                                        const match = text.match(/(\d+)/);
                                        if (match) {
                                            return parseInt(match[1]) === experienceMonths;
                                        }
                                        return false;
                                    });
                                    
                                    if (matchingNode) {
                                        selectedNodeId = matchingNode.id;
                                        console.log(`  -> Seleccionado por experiencia (${experienceMonths} meses): ${matchingNode.name} (ID: ${selectedNodeId})`);
                                    } else {
                                        console.warn(`  -> No se encontró nodo con experiencia de ${experienceMonths} meses. Opciones disponibles:`, 
                                            nodes.map(n => ({id: n.id, name: n.name, name_extra: n.name_extra})));
                                        if (autoSelectFirst) {
                                            selectedNodeId = nodes[0].id;
                                            console.log(`  -> Seleccionado primer nodo por defecto: ${nodes[0].name}`);
                                        }
                                    }
                                } else if (autoSelectFirst && expectedType !== 'RESULT') {
                                    // Para otros niveles (excepto RESULT), seleccionar el primero por defecto
                                    selectedNodeId = nodes[0].id;
                                    console.log(`  -> Seleccionado por defecto: ${nodes[0].name} (ID: ${selectedNodeId})`);
                                } else {
                                    // Para RESULT o cuando autoSelectFirst es false, dejar vacío
                                    console.log(`  -> No se pre-selecciona ningún valor (vacío)`);
                                }
                                
                                this.selectedNodes.push(selectedNodeId);
                            } else {
                                console.error(`Tipo esperado ${expectedType} no coincide con ${nodes[0]?.type}`);
                            }
                        } catch(e) {
                            console.error('Error fetching level:', e);
                        }
                    },
                    async handleNodeChange(index) {
                        const id = this.selectedNodes[index];
                        const level = this.valuationLevels[index];
                        
                        // Solo procesar si es el nivel RESULT (el único habilitado)
                        if (level && level.type === 'RESULT' && id) {
                            const sel = level.options.find(n => n.id == id);
                            
                            if (sel && sel.classification_id) {
                                this.selectedGroup = sel.classification_id;
                            }
                        }
                    },
                    getValuationLabel(type) {
                        const labels = {
                            'ROLE': '1. Rol',
                            'INSTRUCTION': '2. Instrucción Formal',
                            'EXPERIENCE': '3. Experiencia',
                            'DECISION': '4. Toma de Decisiones',
                            'IMPACT': '5. Impacto de Gestión',
                            'COMPLEXITY': '6. Nivel de Complejidad',
                            'RESULT': '7. Grupo Ocupacional'
                        };
                        return labels[type] || type;
                    },
                    initSelect2Valuation() {
                        const self = this;
                        
                        // Limpiar Select2 existentes
                        $('.select2-valuation-assign').each(function() {
                            if ($(this).hasClass('select2-hidden-accessible')) {
                                $(this).select2('destroy');
                            }
                        });
                        
                        // Inicializar Select2 con dropdownParent correcto
                        $('.select2-valuation-assign').select2({
                            width: '100%',
                            dropdownParent: $('#assign-group-app .modal-overlay'),
                            placeholder: 'Seleccione una opción...',
                            allowClear: false,
                            dropdownCssClass: 'select2-dropdown-modal'
                        }).off('change.vue').on('change.vue', function() {
                            const idx = $(this).data('index');
                            const val = $(this).val();
                            if (self.selectedNodes[idx] !== val) {
                                self.selectedNodes[idx] = val;
                                self.handleNodeChange(idx);
                            }
                        });
                    },
                    initSelect2Group() {
                        const self = this;
                        
                        if ($('.select2-group').hasClass('select2-hidden-accessible')) {
                            $('.select2-group').select2('destroy');
                        }
                        
                        $('.select2-group').select2({
                            width: '100%',
                            dropdownParent: $('#assign-group-app .modal-container')
                        }).off('change.vue').on('change.vue', function() {
                            self.selectedGroup = $(this).val();
                        });
                    },
                    async submitAssignment() {
                        // Verificar que se haya seleccionado un nodo RESULT
                        const resultLevelIndex = this.valuationLevels.findIndex(l => l.type === 'RESULT');
                        if (resultLevelIndex === -1 || !this.selectedNodes[resultLevelIndex]) {
                            Swal.fire('Atención', 'Debe seleccionar un grupo ocupacional', 'warning');
                            return;
                        }
                        
                        const selectedResultNode = this.valuationLevels[resultLevelIndex].options.find(
                            n => n.id == this.selectedNodes[resultLevelIndex]
                        );
                        
                        if (!selectedResultNode || !selectedResultNode.classification_id) {
                            Swal.fire('Error', 'El grupo seleccionado no tiene clasificación asociada', 'error');
                            return;
                        }
                        
                        this.loading = true;
                        try {
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            
                            const res = await fetch('/function_manual/api/profile/assign-group/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({
                                    profile_id: this.profileId,
                                    matrix_id: selectedResultNode.classification_id
                                })
                            });
                            const data = await res.json();
                            
                            if(data.success) {
                                Swal.fire('Guardado', 'Grupo asignado correctamente', 'success').then(() => {
                                    location.reload();
                                });
                                this.closeModal();
                            } else {
                                Swal.fire('Error', data.message || 'Error al guardar', 'error');
                            }
                        } catch(e) {
                             Swal.fire('Error', 'Error de conexión', 'error');
                        } finally {
                            this.loading = false;
                        }
                    }
                }
            }).mount('#assign-group-app');
        }
    });
</script>
