<div id="credentials-modal-app" v-cloak>
    <div class="modal-overlay" :class="{ 'hidden': !isVisible }" role="dialog">
        <div class="modal-container-medium animate-scale-in" style="max-width: 800px;">

            <form @submit.prevent="submitCredentials" id="credentialsForm">
                {% csrf_token %}

                <!-- HEADER -->
                <div class="modal-header-medium modal-header-gradient">
                    <h3 class="modal-title text-white">
                        <i class="fa-solid fa-user-lock me-2"></i>
                        <span v-text="isEditing ? 'Editar Credenciales' : 'Crear Credenciales'"></span>
                    </h3>
                    <button type="button" class="btn-close-modal text-white-opacity" @click="closeModal">&times;
                    </button>
                </div>

                <div class="modal-body-content modal-body-custom">

                    <!-- Alerta de Error General -->
                    <div v-if="errors.__all__" class="alert alert-danger">
                        <i class="fa-solid fa-circle-exclamation me-2"></i>
                        <span v-for="err in errors.__all__">[[ err ]]</span>
                    </div>

                    <!-- Información Empleado -->
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="fa-solid fa-circle-user me-3 fs-3"></i>
                        <div>
                            <small class="d-block text-uppercase fw-bold" style="font-size: 0.7rem; opacity: 0.8;">Asignando
                                usuario a:</small>
                            <span class="fw-bold fs-6">[[ employeeName ]]</span>
                        </div>
                    </div>

                    <!-- INPUTS PRINCIPALES (Usando creds_form) -->
                    <div class="form-section-card">
                        <div class="grid-2-cols">
                            <!-- Usuario -->
                            <div class="form-group">
                                <label class="form-label">Nombre de Usuario <span class="text-danger">*</span></label>
                                <input type="text"
                                       name="username"
                                       v-model="creds_form.username"
                                       class="input-field lowercase-input"
                                       :readonly="isEditing"
                                       :class="{ 'bg-secondary-subtle cursor-not-allowed': isEditing }"
                                       placeholder="ej: juan.perez"
                                       autocomplete="off">

                                <div class="error-message-container" v-if="errors.username">
                                    <span class="text-error" v-for="err in errors.username">[[ err ]]</span>
                                </div>

                                <!-- Mensaje de ayuda condicional -->
                                <small class="form-hint" v-if="!isEditing">Ej: juan.perez</small>
                                <small class="form-hint text-warning" v-if="isEditing">
                                    <i class="fa-solid fa-lock"></i> El usuario no se puede modificar
                                </small>
                            </div>

                            <!-- Rol -->
                            <div class="form-group">
                                <label class="form-label">Rol / Perfil <span class="text-danger">*</span></label>
                                {{ creds_form.role }}
                                <div class="error-message-container" v-if="errors.role">
                                    <span class="text-error" v-for="err in errors.role">[[ err ]]</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CONTRASEÑAS -->
                    <div class="form-section-card">
                        <h6 class="section-title">
                            <i class="fa-solid fa-shield-halved me-2"></i>Seguridad de Acceso
                        </h6>
                        <div class="grid-2-cols">
                            <div class="form-group">
                                <label class="form-label">Contraseña <span v-if="!isEditing"
                                                                           class="text-danger">*</span></label>
                                {{ creds_form.password }}
                                <div class="error-message-container" v-if="errors.password">
                                    <span class="text-error" v-for="err in errors.password">[[ err ]]</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar Contraseña <span v-if="!isEditing"
                                                                                     class="text-danger">*</span></label>
                                {{ creds_form.confirm_password }}
                                <div class="error-message-container" v-if="errors.confirm_password">
                                    <span class="text-error" v-for="err in errors.confirm_password">[[ err ]]</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOGGLES DE ESTADO -->
                    <div class="form-section-card">
                        <h6 class="section-title">
                            <i class="fa-solid fa-sliders me-2"></i>Permisos y Estado
                        </h6>
                        <div class="permissions-toggle-grid">
                            <!-- Toggle Activo -->
                            <div class="toggle-item">
                                <label class="toggle-switch">
                                    {{ creds_form.is_active }}
                                    <span class="toggle-slider"></span>
                                </label>
                                <div class="toggle-info">
                                    <span class="toggle-label">Usuario Activo</span>
                                    <small class="toggle-hint">Puede iniciar sesión</small>
                                </div>
                            </div>

                            <!-- Toggle Staff -->
                            <div class="toggle-item">
                                <label class="toggle-switch">
                                    {{ creds_form.is_staff }}
                                    <span class="toggle-slider"></span>
                                </label>
                                <div class="toggle-info">
                                    <span class="toggle-label">Acceso Administrativo</span>
                                    <small class="toggle-hint">Acceso administrador</small>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- FOOTER -->
                <div class="modal-footer-medium modal-footer-spaced">
                    <button type="button" class="btn-cancel" @click="closeModal">
                        <i class="fa-solid fa-xmark me-2"></i>Cancelar Operación
                    </button>
                    <button type="submit" class="btn-save shadow-md">
                        <i class="fa-solid fa-floppy-disk me-2"></i>
                        <span v-text="isEditing ? 'Actualizar Credenciales' : 'Crear Credenciales'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>