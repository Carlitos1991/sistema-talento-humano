{% load static %}
<div class="table-container">
    <table>
        <thead>
        <tr>
            <th><i class="fa-solid fa-list-ol"></i></th>
            <th><i class="far fa-user"></i>Empleado</th>
            <th><i class="far fa-envelope header-icon"></i> Email</th>
            <th><i class="fas fa-phone header-icon"></i> Teléfono</th>
            <th><i class="fas fa-building header-icon"></i> Rol de usuario</th>
            <th><i class="fas fa-toggle-on header-icon"></i> Estado</th>
            <th><i class="fas fa-cogs header-icon"></i> Acciones</th>
        </tr>
        </thead>
        <tbody id="table-body">
        {% for person in persons %}
            <tr class="catalog-row" id="row-{{ person.id }}" data-status="{{ person.is_active|yesno:'true,false' }}">
                <td>{{ forloop.counter }}</td>

                <!-- CLASE PARA ENCONTRAR EL NOMBRE -->
                <td>
                    <div class="person-info">
                        {% if person.photo %}
                            <img src="{{ person.photo.url }}" alt="{{ person.first_name }}" class="person-avatar">
                        {% else %}
                            <div class="person-avatar-placeholder">
                                {{ person.first_name|first }}{{ person.last_name|first }}
                            </div>
                        {% endif %}
                        <div class="person-details">
                            <!-- Invertí el orden habitual: Nombre Apellido -->
                            <h4>{{ person.first_name }} {{ person.last_name }}</h4>
                            <p><i class="far fa-address-card"></i> {{ person.document_number|default:"S/N" }}</p>
                        </div>
                    </div>
                </td>

                <td>{{ person.email|default:"--" }}</td>
                <td>{{ person.phone_number|default:"--" }}</td>
                <td class="text-center">
                    {% if person.user %}
                        {% if person.user.groups.exists %}
                            {% for group in person.user.groups.all %}
                                <span class="status-badge status-badge-user-role">
                                    {{ group.name }}
                                </span>
                            {% endfor %}
                        {% else %}
                            <span class="status-badge badge-neutral">SIN ROL</span>
                        {% endif %}
                    {% else %}
                        <span class="status-badge status-badge-no-account">
                            SIN CUENTA
                        </span>
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if person.user %}
                        {% if person.user.is_active %}
                            <span class="status-badge active">
                <i class="fa-solid fa-check-circle me-1"></i> Activo
                    </span>
                        {% else %}
                            <span class="status-badge inactive">
                        <i class="fa-solid fa-ban me-1"></i> Inactivo
                    </span>
                        {% endif %}
                    {% else %}
                        <!--  No tiene usuario asociado -->
                        <span class="status-badge status-badge-no-account">
                            SIN CUENTA
                        </span>
                    {% endif %}
                </td>

                <td class="actions">
                    <div class="actions-wrapper">
                        {% if perms.core.change_user or perms.core.add_user %}
                            <button class="btn-icon btn-list-action btn-manage-user"
                                    data-url="{% url 'security:user_create_credentials' person.pk %}"
                                    data-name="{{ person.first_name }} {{ person.last_name }}"
                                    title="Gestionar Usuario">
                                {% if person.user %}
                                    <i class="fas fa-user-pen"></i>
                                {% else %}
                                    <i class="fas fa-user-plus"></i>
                                {% endif %}
                            </button>
                        {% endif %}
                        {% if person.user and perms.core.change_user %}
                            {% if person.user.is_active %}
                                <button class="btn-icon btn-delete-action"
                                        onclick="toggleUserStatus('{{ person.id }}', '{{ person.first_name }}', true)"
                                        title="Desactivar Acceso">
                                    <i class="fas fa-power-off"></i>
                                </button>
                            {% else %}
                                <button class="btn-icon btn-create-action"
                                        onclick="toggleUserStatus('{{ person.id }}', '{{ person.first_name }}', false)"
                                        title="Activar Acceso">
                                    <i class="fas fa-toggle-on"></i>
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div id="pagination-metadata" class="hidden"
         data-total="{{ page_obj.paginator.count }}"
         data-page="{{ page_obj.number }}"
         data-pages="{{ page_obj.paginator.num_pages }}"
         data-start="{{ page_obj.start_index }}"
         data-end="{{ page_obj.end_index }}"
         data-has-next="{{ page_obj.has_next|yesno:'true,false' }}"
         data-has-prev="{{ page_obj.has_previous|yesno:'true,false' }}">
    </div>
    <div class="no-results-overlay {% if persons %}hidden{% endif %}">
        <!-- Mensaje 2: Búsqueda sin coincidencias -->
        <div class="no-results-content hidden" id="no-results-placeholder">
            <i class="fas fa-search no-results-icon"></i>
            <p class="no-results-text">No se encontraron resultados.</p>
        </div>
    </div>
</div>